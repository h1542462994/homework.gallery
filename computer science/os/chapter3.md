# 操作系统 第三章 物理内存

## 计算机体系结构/内存分层体系

### 计算机体系结构

三部分内容：CPU、内存、IO设备

### 内存分层体系

分层：寄存器、L1缓存、L2缓存、主存、磁盘（虚拟内存）。

**内存管理单元：MMU**

操作系统管理的目标：
- 抽象：逻辑地址空间
- 保护：独立地址空间
- 共享：访问相同内存
- 虚拟化：更多的地址空间

## 地址空间 & 地址生成

地址空间：
- 物理地址空间
- 逻辑地址空间
逻辑地址生成：编译、汇编、链接、载入。（linker，loader）
- 逻辑地址生成
    - CPU发出取逻辑内存内容的请求
    - CPU中的MMU查出逻辑映射表，如果找不到则找内存的Map
    - CPU中的控制器发出请求，获得指令的内容。
    - 主存将内容通过总线传给CPU。
- 内存异常
    - 界限寄存器、基址寄存器

## 连续内存分配

- 内存碎片问题
    - 外部碎片：分配单元之间未被使用的内存
    - 内部碎片：分配单元内部的未被使用的内存，取决于分配单元大小是否要取整。

### 分配方法

第一匹配分配（First Fit）：使用第一个可用空间块。

- 优点
    - 简单
    - 易于产生更大空闲块，向着地址空间的结尾
- 劣势
    - 外部碎片
    - 不确定性

最优适配算法（Best Fit）：使用最适合的可用空间块

- 优势
    - 当大部分分配时小尺寸时非常有效
    - 比较简单
- 劣势
    - 外部碎片
    - 重分配慢
    - 易产生很多没用的微小碎片（不怎么好）

最差匹配分配（Worst Fit）：使用最大的可用空间块

- 优势
    - 假如分配是中等尺寸效果最好
- 劣势
    - 重分配慢
    - 外部碎片
    - 易于破碎大的空闲块以致大分区无法被分配

## 内存碎片整理

## 压缩式碎片整理(Compaction)

- 重置程序以合并孔洞
- 要求所有程序是动态可重置的
- 议题
    - 何时重置？
    - 开销

## 交换式碎片整理(Swapping)

- 运行程序需要更多的内存
- 抢占等待的程序 & 回收它们的内存