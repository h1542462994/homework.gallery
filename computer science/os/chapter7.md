# 操作系统 第七章 文件系统

## 基本概念

### 文件系统和文件

文件系统：一种用于持久性存储的系统抽象

文件：文件系统中一个单元的相关数据在操作系统中的抽象

文件属性

- 文件头：
    - 在存储元数据中保存了每个文件的信息
    - 保存文件的属性
    - 跟踪哪一块存储块属于逻辑上文件结构的哪个偏移

#### 分配文件磁盘空间

- 管理文件快
- 管理空闲空间
- 分配算法

#### 管理文件集合

- 定位文件机器内容
- 命名：通过名字找到文件的接口
- 最常见：分层文件系统
- 文件系统类型（组织文件的不同方式）

#### 提供的便利及特征

- 保护：分层来保护数据安全
- 可靠性/持久性：包哦吃文件的持久即使发生崩溃、媒体错误、攻击等

### 文件描述符

文件使用模式，内核跟踪每个进程打开的文件

需要元数据数据来管理打开文件：
- 文件指针：只想最近的一个读写位置，每个打开了这个文件的进程都这个指针
- 文件打开计数：记录文件打开的次数——当最后一个进程关闭了文件时，允许将其从打开文件表中移除
- 文件磁盘位置：缓存数据访问信息
- 访问权限：每个程序访问模式信息

用户视图：持久的数据结构

系统访问接口：字节的集合

操作系统内部视角：块的集合（块是逻辑转换单元，而扇区是物理转换单元）

用户怎么访问文件：在系统层面需要知道用户的访问模式

顺序访问：按字节依次读取，几乎所有的访问都是这种方式

随机访问：从中间读写
- 不常用，但是仍然重要，例如，虚拟内存支持文件，内存页存储在文件中
- 更加快速——不希望获取文件中间的内容的时候也必须先获取块内所有字节

根据内容访问：通过特征
- 许多系统不提供此种访问方式，相反，数据库是建立在索引内容的磁盘访问上的（需要高效的随机访问）

#### 文件结构

无结构
- 单词、比特的队列

简单记录结构
- 列，固定长度，可变长度

复杂结构
- 格式化的文档
- 可执行文件

#### 文件保护

- 访问控制
    - 谁能够获得哪些文件的哪些访问权限
    - 访问模式
- 文件访问控制列表
- Unix模式
- 指定多用户/客户如何访问共享文件
- Unix文件系统（UFS）语义
    - 对打开文件的写入内容立即对其他打开同一文件的其他用户可见
    - 共享文件指针允许多用户同时读取和写入文件
- 会话语义
    - 写入内容只有当文件关闭时可见
- 锁
    - 一些操作系统和文件系统提供该功能

### 目录

- 文件以目录的方式组织起来
- 目录是一类特殊的文件
    - 每个目录都包含了一张表
- 目录和文件的树型结构
    - 层次名称空间
- 典型操作
    - 搜索文件
    - 创建文件
    - 删除文件
    - 枚举目录
    - 重命名文件
    - 在文件系统中遍历一个路径
- 操作系统应该只允许内核模式修改目录
    - 确保映射的完整性
    - 应用程序能读目录
- 文件名的线性列表，包含了指向数据块的指针
- Hash表- hash数据结构的线性表

#### 路径遍历

名称解析：逻辑名字转换成物理资源（如文件）的过程


### 文件别名

两个或多个文件名关联同一个文件
- 硬链接：多个文件项指向一个文件
- 软连接：以“快捷方式”指向其他文件

#### 实现方案

Backpoints方案：
- 每个文件有一个包含多个backpoints的列表，所以删除所有的backpoins
- Backpoints使用菊花链管理

#### 添加一个间接层：目录项数据结构

- 链接 - 已存在文件的另外一个名字
- 链接处理 - 跟随指针来定位文件

### 文件系统种类

- 磁盘文件系统
    - 文件存储在数据存储设备上，如磁盘
    - 例如：FAT，NTFS，ext2/3，ISO9660，等
- 数据库文件系统
    - 文件根据其特征是可被寻址（辨识）的
    - 例如：WinFS
- 日志文件系统
    - 记录文件系统的修改/事件
- 网络/分布式文件系统
    - 例如：NFS，SMB，AFS，GFS
    - 文件可以通过网络被共享
    - 分布式文件系统的问题
- 特殊/虚拟文件系统‘

## 虚拟文件系统

### 分层结构

- 上层：虚拟（逻辑）文件系统
- 底层：特定文件系统模块

### 目的

对所有不同文件系统的抽象

### 功能

- 提供相同的文件和文件系统接口
- 管理所有文件和文件系统关联的数据结构
- 高效查询例程，遍历文件系统
- 与特定文件系统模块的交互

### 实现

### 数据结构

- 卷控制块
- 文件控制块
- 目录节点
    - 每个目录项一个（目录和文件）
    - 将目录项数据结构及树型布局编码成树型数据结构
    - 指向文件控制块、父节点、项目列表等

持续存储在二级存储中

当需要时加载进内存
- 卷控制模块：当文件系统挂载时进入内存
- 文件控制块：当文件被访问时进入每次
- 目录节点：在遍历一个文件路径时进入内存

### 数据块缓存

- 数据块按需读入内存
- 数据块使用后被缓存
- 两种数据块缓存方寸

当需要一个页时才将其载入内存，支持存储，一个页（在虚拟地址空间中）可以被映射到一个本地文件中

### 打开文件的数据结构

打开文件描述
- 每个被打开的文件一个
- 文件状态信息
- 目录项、当前文件指针、文件操作设置等

打开文件表
- 一个进程一个
- 一个系统级的
- 每个卷控制块也会保存一个列表
- 所以如果有文件被打开将不能被卸载

- 一些操作系统和文件系统提供该功能
- 调节对文件的访问
- 强制和劝告

### 文件分配

- 大多数文件都很小
    - 需要对小文件提供强力的支持
    - 块空间不能太大
- 一些文件非常大
    - 必须支持大文件（64-bit文件偏移）
    - 大文件访问需要相当高效

- 如何为一个文件分配数据块
- 分配方式
    - 连续分配，链式分配，索引分配
- 指标：
    - 高效：如存储利用（外部碎片）
    - 表现：如访问速度

### 空闲空间列表

- 跟踪在存储中的所有未分配的数据块
- 使用位图的方式，先设置磁盘，再设置内存。

## 多磁盘管理-RAID

## 磁盘调度

- 读取或写入时，磁头必须被定位在期望的磁道，并从所期望的磁道扇区开始
- 寻道时间：定位到期望的磁道所花费的事件
- 旋转延迟：从扇区的开始处到达目的地所花费的时间

$$T_a=T_s+\frac{1}{2r}+\frac{b}{rN}(寻道)$$

FIFO：先入先出

SSTF：最短路径优先

SCAN：电梯扫描

C-SCAN：单向扫描

C-SCAN的改进版本

N-Step-SCAN

F-SCAN：FSCAN算法实质上是N步SCAN算法的简化，即FSCAN只将磁盘请求队列分成两个子队列