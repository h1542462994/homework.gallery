# 操作系统 第三章 物理内存

## 计算机体系结构/内存分层体系

### 计算机体系结构

三部分内容：CPU、内存、IO设备

### 内存分层体系

分层：寄存器、L1缓存、L2缓存、主存、磁盘（虚拟内存）。

**内存管理单元：MMU**

操作系统管理的目标：
- 抽象：逻辑地址空间
- 保护：独立地址空间
- 共享：访问相同内存
- 虚拟化：更多的地址空间

### Cache分配算法

映射函数，替换算法，写策略（直写，回写，写一次法）

## 地址空间 & 地址生成

地址空间：
- 物理地址空间
- 逻辑地址空间
逻辑地址生成：编译、汇编、链接、载入。（linker，loader）
- 逻辑地址生成
    - CPU发出取逻辑内存内容的请求
    - CPU中的MMU查出逻辑映射表，如果找不到则找内存的Map
    - CPU中的控制器发出请求，获得指令的内容。
    - 主存将内容通过总线传给CPU。
- 内存异常
    - 界限寄存器、基址寄存器

## 连续内存分配

- 内存碎片问题
    - 外部碎片：分配单元之间未被使用的内存
    - 内部碎片：分配单元内部的未被使用的内存，取决于分配单元大小是否要取整。

### 分配方法

第一匹配分配（First Fit）：使用第一个可用空间块。

- 优点
    - 简单
    - 易于产生更大空闲块，向着地址空间的结尾
- 劣势
    - 外部碎片
    - 不确定性

最优适配算法（Best Fit）：使用最适合的可用空间块

- 优势
    - 当大部分分配时小尺寸时非常有效
    - 比较简单
- 劣势
    - 外部碎片
    - 重分配慢
    - 易产生很多没用的微小碎片（不怎么好）

最差匹配分配（Worst Fit）：使用最大的可用空间块

- 优势
    - 假如分配是中等尺寸效果最好
- 劣势
    - 重分配慢
    - 外部碎片
    - 易于破碎大的空闲块以致大分区无法被分配

### 内存碎片整理

#### 压缩式碎片整理(Compaction)

- 重置程序以合并孔洞
- 要求所有程序是动态可重置的
- 议题
    - 何时重置？
    - 开销

#### 交换式碎片整理(Swapping)

- 运行程序需要更多的内存
- 抢占等待的程序 & 回收它们的内存

## 非连续内存分配

### 连续内存分配的缺点

- 分配给一个程序的物理内存是连续的
- 内存利用率较低
- 有外碎片、内碎片的问题

### 非连续分配的优点

- 一个程序的物理地址空间是非连续的
- 更好的内存利用和管理
- 允许共享代码和数据（共享库等……）
- 支持动态加载和动态链接

### 非连续分配的缺点

- 如何建立虚拟地址和物理地址之间的转换
    - 软件方案
    - 硬件方案
- 两种硬件方案
    - 分段
    - 分页

### 分段

更好的分离和共享：堆，运行栈，程序数据，程序代码

#### 分段寻址方案

段访问机制

- 新概念：一个段；一个内存“块”
    - 一个逻辑地址空间
- 程序访问内存地址需要
    - 一个2维的二元组(s,addr)

硬件方案：使用段表(segment table)，操作系统设置段表

### 分页

- 划分物理内存至固定大小的帧(Frame)
- 划分逻辑地址空间至相同大小的页(Page)
- 建立方案 转换逻辑地址为物理地址(page to frames)
    - 页表
    - MMU/TLB

#### 帧

物理内存被分割为大小相同的帧

一个内存物理地址是一个二元组(f,o)

#### 页

一个程序的逻辑地址空间被划分为大小相等的页

- 页内偏移的大小=帧内偏移大小
- 页号大小<>帧号大小

页表：页表基址，页号，帧号

#### 区别

- 页映射到帧
- 页是连续的虚拟内存
- 帧是非连续的物理内存
- 不是所有的页都有对应的帧

#### 页表

##### 页表结构

- 每个运行的程序都有一个页表
    - 属于程序的运行状态，会动态变化
    - PTBR：页表基址寄存器

- 页表项的内容
    - Flags
        - dirty bit
        - resident bit
        - clock/reference bit
    - 帧号：f

##### 分页机制的性能问题

- 问题：访问一个内存单元需要2次访问
    - 一次用于获取页表项
    - 一次用于访问数据
- 页表可能非常大
    - 64位机器如果每页1024字节，那么一个页表的大小会是大小？
- 解决方法
    - 缓存（Cache）
    - 间接（Indirectin）

##### Translation Look-aside Buffer(TLB)

- 缓存近期访问的页帧转换表项
    - TLB使用assocative memory（关联内存）实现，具备快速访问性能
    - 如果TLB命中，物理页号可以很快被获取
    - 如果TLB未命中，对应的表项被更新到TLB中。

#### 二级页表

- 优点
    - 可以减少不存在的映射关系的内存空间。

#### 多级页表

#### 反向页表

- 基于页寄存器（page registers）的方案
- 基于关联内存（associative memory）的方案。
- 基于哈希(hash)查找的方案（正向使用hash算法来实现）
    - 需要高效的hash函数
    - 需要好的hash冲突的解决方案
